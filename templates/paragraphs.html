{% extends 'base.html' %}

{% block title %}Paragraphs{% endblock title %}

{% block head %}
<style>
  /* Custom styles for optimized paragraph display */
  .paragraph-card {
    transition: all 0.2s ease;
    margin-bottom: 1rem;
  }
  
  .paragraph-card.highlight-sort {
    animation: highlight-card 1.5s ease;
  }
  
  @keyframes highlight-card {
    0% { background-color: rgba(87, 135, 235, 0.1); }
    100% { background-color: transparent; }
  }
  
  .document-references {
    max-height: 100px;
    overflow-y: auto;
    scrollbar-width: thin;
    display: none; /* Hide document references by default */
  }
  
  .document-references.show {
    display: block; /* Show when explicitly toggled */
  }
  
  .paragraph-preview {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .paragraph-full-content {
    max-height: 300px;
    overflow-y: auto;
    scrollbar-width: thin;
  }
  
  .paragraph-full-content pre.table-content {
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  /* List item specific styling */
  .paragraph-full-content.list-item-content {
    padding-left: 20px;
    text-indent: -20px;
    white-space: pre-line;  /* Preserve line breaks within list items */
  }
  
  .pagination-controls {
    margin: 1rem 0;
  }
  
  .occurrence-badge {
    cursor: pointer; /* Make it clear this is clickable */
    transition: background-color 0.2s ease;
  }
  
  .occurrence-badge:hover {
    background-color: #0dcaf0 !important; /* Slightly brighter on hover */
  }
  
  .occurrence-badge.active {
    background-color: #0dcaf0 !important; /* Highlight when active */
  }
  
  .filter-panel-toggle {
    cursor: pointer;
  }
  
  /* Fade effect for documents list expansion */
  .documents-fade {
    position: relative;
  }
  
  /* Virtual scroll container */
  .virtual-scroll-container {
    position: relative;
    overflow: auto;
    height: calc(100vh - 180px); /* Increased height by reducing offset */
    min-height: 400px;
  }
  
  /* Loading indicator */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255,255,255,0.7);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  
  .loading-spinner {
    width: 3rem;
    height: 3rem;
  }
  
  /* Batch selection */
  .batch-action-bar {
    position: sticky;
    bottom: 0;
    background: white;
    border-top: 1px solid #dee2e6;
    padding: 0.75rem;
    z-index: 10;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
    display: none;
  }
  
  .batch-action-bar.visible {
    display: block;
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  
  /* Selection checkbox */
  .paragraph-select {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 5;
  }
  
  /* Highlight found text */
  mark.search-highlight {
    background-color: #fff3cd;
    padding: 0.1em 0.2em;
    border-radius: 2px;
  }
  
  /* Sticky pagination controls */
  .sticky-pagination {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 6px;
    padding: 5px 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    opacity: 0.95;
  }
  
  .sticky-pagination:hover {
    opacity: 1;
  }
  
  /* Compact header */
  .compact-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .compact-header h5 {
    margin-bottom: 0;
  }
  
  /* View toggle button */
  .view-toggle {
    position: fixed;
    bottom: 80px;
    right: 20px;
    z-index: 1000;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #5787eb;
    color: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  
  .view-toggle:hover {
    background: #3d6ed4;
  }

  /* Filter toggle icon */
  .filter-toggle-icon {
    transition: transform 0.3s ease;
  }
  
  .filter-panel-toggle[aria-expanded="true"] .filter-toggle-icon {
    transform: rotate(180deg);
  }
  
  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
  }
  
  /* Shimmer loading effect */
  .shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  
  @keyframes shimmer {
    0% { background-position: -100% 0; }
    100% { background-position: 100% 0; }
  }
  
  .paragraph-placeholder {
    height: 120px;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
    overflow: hidden;
  }
</style>
{% endblock head %}

{% block content %}
<!-- Compact Header Area -->
<div class="compact-header pt-2">
  <div>
    <h5 class="mb-0">Paragraphs</h5>
    <p class="text-muted small mb-0">View and analyze paragraph content across documents</p>
  </div>
  <div class="dropdown">
    <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="headerActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-gear"></i> Actions
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="headerActionsDropdown">
      <li><a href="/export" class="dropdown-item"><i class="bi bi-file-excel me-1"></i> Export to Excel</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="#" id="selectAllBtn"><i class="bi bi-check-all me-2"></i>Select All on Page</a></li>
      <li><a class="dropdown-item" href="#" id="deselectAllBtn"><i class="bi bi-x-circle me-2"></i>Deselect All</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="#" id="showStatsBtn"><i class="bi bi-bar-chart me-2"></i>Paragraph Statistics</a></li>
    </ul>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
  <div class="spinner-border text-primary loading-spinner" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3" id="loadingMessage">Processing paragraphs...</p>
</div>

<!-- Filter Panel (collapsed by default) -->
<div class="card mb-3">
  <div class="card-header py-2 d-flex justify-content-between align-items-center filter-panel-toggle" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false">
    <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filter & Sort Options</h6>
    <button class="btn btn-sm btn-light p-1">
      <i class="bi bi-chevron-down filter-toggle-icon"></i>
    </button>
  </div>
  <div class="collapse" id="filterCollapse">
    <div class="card-body py-2">
      <div class="row g-2">
        <div class="col-md-3">
          <label for="documentFilter" class="form-label small"><i class="bi bi-file-earmark me-1"></i>Document</label>
          <select class="form-select form-select-sm" id="documentFilter">
            <option value="">All Documents</option>
            {% for doc in documents %}
              <option value="{{ doc.id }}" {% if selected_document == doc.id %}selected{% endif %}>{{ doc.filename }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="paragraphTypeFilter" class="form-label small"><i class="bi bi-type me-1"></i>Paragraph Type</label>
          <select class="form-select form-select-sm" id="paragraphTypeFilter">
            <option value="">All Types</option>
            <option value="header">Headers</option>
            <option value="normal">Normal Paragraphs</option>
            <option value="list_item">List Items</option>
            <option value="list">Lists</option>
            <option value="table">Tables</option>
            <option value="boilerplate">Boilerplate</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="tagFilter" class="form-label small"><i class="bi bi-tag me-1"></i>Tag</label>
          <select class="form-select form-select-sm" id="tagFilter">
            <option value="">All Tags</option>
            {% for tag in tags %}
              <option value="{{ tag.id }}">{{ tag.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="duplicateFilter" class="form-label small"><i class="bi bi-files me-1"></i>Duplicates</label>
          <select class="form-select form-select-sm" id="duplicateFilter">
            <option value="0" {% if not show_all_duplicates %}selected{% endif %}>Show Once (Collapsed)</option>
            <option value="1" {% if show_all_duplicates %}selected{% endif %}>Show All Instances</option>
          </select>
        </div>
      </div>
      
      <!-- Sorting and Advanced Options -->
      <div class="row mt-2 g-2">
        <div class="col-md-3">
          <label for="sortOption" class="form-label small"><i class="bi bi-sort-alpha-down me-1"></i>Sort By</label>
          <select class="form-select form-select-sm" id="sortOption">
            <option value="position-asc">Default Order</option>
            <option value="occurrences-desc" selected>Occurrences (High to Low)</option>
            <option value="occurrences-asc">Occurrences (Low to High)</option>
            <option value="length-desc">Length (Long to Short)</option>
            <option value="length-asc">Length (Short to Long)</option>
            <option value="document-asc">Document Name</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="minLengthFilter" class="form-label small"><i class="bi bi-text-paragraph me-1"></i>Min Length</label>
          <div class="input-group input-group-sm">
            <input type="number" class="form-control form-control-sm" id="minLengthFilter" min="0" value="0" placeholder="Min chars">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="showLengthsBtn" title="Show character counts">
              <i class="bi bi-info-circle"></i>
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <label for="searchParagraphs" class="form-label small"><i class="bi bi-search me-1"></i>Search Content</label>
          <div class="input-group input-group-sm">
            <input type="text" class="form-control form-control-sm" id="searchParagraphs" placeholder="Search paragraph content...">
            <button class="btn btn-outline-primary btn-sm" type="button" id="clearSearchBtn">
              <i class="bi bi-x-circle"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div class="row mt-3">
        <div class="col-12">
          <button type="button" class="btn btn-primary btn-sm" id="applyFiltersBtn">
            <i class="bi bi-funnel-fill me-1"></i> Apply Filters
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="resetFiltersBtn">
            <i class="bi bi-arrow-counterclockwise me-1"></i> Reset Filters
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Count and Controls - More compact -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <div>
    <span class="badge bg-primary rounded-pill" id="paragraphCount">
      {{ total_paragraphs }} paragraphs
    </span>
    <span class="badge bg-info rounded-pill ms-2" id="pageInfo">
      Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
    </span>
    {% if show_all_duplicates %}
      <span class="badge bg-info rounded-pill ms-2">
        <i class="bi bi-files me-1"></i> Showing all duplicates
      </span>
    {% else %}
      <span class="badge bg-secondary rounded-pill ms-2">
        <i class="bi bi-files me-1"></i> Duplicates collapsed
      </span>
    {% endif %}
  </div>
  <div>
    <button class="btn btn-sm btn-outline-primary py-0 px-2" id="expandAllParasBtn">
      <i class="bi bi-arrows-expand me-1"></i> Expand All
    </button>
    <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="collapseAllParasBtn">
      <i class="bi bi-arrows-collapse me-1"></i> Collapse All
    </button>
  </div>
</div>

<!-- Paragraphs Virtual Scroll Container -->
<div class="virtual-scroll-container">
  <div id="paragraphsList">
    <!-- Placeholders while loading -->
    <div id="paragraphPlaceholders">
      {% for i in range(5) %}
        <div class="paragraph-placeholder shimmer"></div>
      {% endfor %}
    </div>
    
    <!-- Paragraphs will be rendered here by JavaScript -->
  </div>
</div>

<!-- Sticky Pagination Controls (fixed position) -->
<div class="sticky-pagination" id="stickyPagination">
  <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="firstPageBtn">
    <i class="bi bi-chevron-double-left"></i>
  </button>
  <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="prevPageBtn">
    <i class="bi bi-chevron-left"></i>
  </button>
  <span class="mx-2 small">
    Page <span id="paginationCurrentPage">1</span> of <span id="paginationTotalPages">1</span>
  </span>
  <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="nextPageBtn">
    <i class="bi bi-chevron-right"></i>
  </button>
  <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="lastPageBtn">
    <i class="bi bi-chevron-double-right"></i>
  </button>
  <select class="form-select form-select-sm ms-2" id="pageSizeSelect" style="width: auto;">
    <option value="10">10</option>
    <option value="25" selected>25</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select>
</div>

<!-- Compact View Toggle Button -->
<button class="btn view-toggle" id="viewToggleBtn" title="Toggle Compact View">
  <i class="bi bi-layout-text-window-reverse"></i>
</button>

<!-- Batch Action Bar -->
<div class="batch-action-bar" id="batchActionBar">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <span class="badge bg-primary rounded-pill" id="selectedCount">0 selected</span>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-secondary" id="cancelSelectionBtn">
          <i class="bi bi-x me-1"></i> Cancel
        </button>
        <div class="dropdown">
          <button class="btn btn-primary dropdown-toggle" type="button" id="batchTagDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-tag me-1"></i> Tag Selected
          </button>
          <ul class="dropdown-menu" aria-labelledby="batchTagDropdown" id="batchTagDropdownMenu">
            {% for tag in tags %}
              <li><a class="dropdown-item" href="#" onclick="batchTagSelected({{ tag.id }})">
                <span class="badge me-2" style="background-color: {{ tag.color }}">&nbsp;</span>{{ tag.name }}
              </a></li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tag Modal -->
<div class="modal fade" id="tagModal" tabindex="-1" aria-labelledby="tagModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="tagModalLabel"><i class="bi bi-tag me-2"></i>Add Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="paragraphIdForTag">
        <div class="mb-3">
          <p class="alert alert-info mb-3">
            <i class="bi bi-info-circle me-2"></i>
            This tag will be applied to all instances of this paragraph across documents.
          </p>
          <label class="form-label">Select Tag</label>
          <div class="d-flex flex-wrap gap-2 tag-selection">
            {% for tag in tags %}
              <div class="tag-item">
                <span class="badge tag-badge" style="background-color: {{ tag.color }}" onclick="addTag({{ tag.id }})">
                  {{ tag.name }}
                </span>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Modal -->
<div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title" id="statisticsModalLabel"><i class="bi bi-bar-chart me-2"></i>Paragraph Statistics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <!-- Type distribution -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">Paragraph Types</div>
              <div class="card-body">
                <div class="mb-3" id="typeDistributionChart" style="height: 200px;">
                  <!-- Chart will be rendered here -->
                </div>
                <div class="type-legend small">
                  <!-- Legend will be populated by JS -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Length distribution -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">Content Length Distribution</div>
              <div class="card-body">
                <div class="mb-3" id="lengthDistributionChart" style="height: 200px;">
                  <!-- Chart will be rendered here -->
                </div>
                <div class="text-center small text-muted mt-2">Character count ranges</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <!-- Tag usage -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">Tag Usage</div>
              <div class="card-body">
                <div id="tagUsageChart" style="height: 200px;">
                  <!-- Chart will be rendered here -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Document distribution -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">Top Documents</div>
              <div class="card-body">
                <div id="documentDistribution" style="height: 200px;">
                  <!-- Chart will be rendered here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
  // Global variables for pagination and data
  let allParagraphs = [];
  let filteredParagraphs = [];
  let currentPage = 1;
  let pageSize = 25;
  let totalPages = 1;
  let totalItems = 0;
  let compactModeEnabled = false;
  let isLoading = false;
  
  // Cache selectors for performance
  const paragraphsListEl = document.getElementById('paragraphsList');
  const paragraphPlaceholders = document.getElementById('paragraphPlaceholders');
  const paragraphCountEl = document.getElementById('paragraphCount');
  const currentPageEls = document.querySelectorAll('#currentPage, #paginationCurrentPage');
  const totalPagesEls = document.querySelectorAll('#totalPages, #paginationTotalPages');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const batchActionBar = document.getElementById('batchActionBar');
  const selectedCountEl = document.getElementById('selectedCount');
  const stickyPagination = document.getElementById('stickyPagination');
  const viewToggleBtn = document.getElementById('viewToggleBtn');
  
  // Filter elements
  const documentFilter = document.getElementById('documentFilter');
  const paragraphTypeFilter = document.getElementById('paragraphTypeFilter');
  const tagFilter = document.getElementById('tagFilter');
  const duplicateFilter = document.getElementById('duplicateFilter');
  const minLengthFilter = document.getElementById('minLengthFilter');
  const searchInput = document.getElementById('searchParagraphs');
  const sortOption = document.getElementById('sortOption');
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  
  // Buttons
  const applyFiltersBtn = document.getElementById('applyFiltersBtn');
  const resetFiltersBtn = document.getElementById('resetFiltersBtn');
  const firstPageBtn = document.getElementById('firstPageBtn');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const lastPageBtn = document.getElementById('lastPageBtn');
  const expandAllParasBtn = document.getElementById('expandAllParasBtn');
  const collapseAllParasBtn = document.getElementById('collapseAllParasBtn');
  
  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    // Initial load of paragraphs from API
    loadParagraphs();
    
    // Set up event listeners
    setupEventListeners();
    
    // Set up compact view toggle
    setupCompactViewToggle();
  });
  
  // Function to load paragraphs from API
  function loadParagraphs() {
    isLoading = true;
    showLoading('Loading paragraphs...');
    
    // Show placeholder shimmer effect
    paragraphPlaceholders.style.display = 'block';
    
    // Build query parameters
    const params = new URLSearchParams();
    params.append('page', currentPage);
    params.append('per_page', pageSize);
    
    // Add filters if selected
    if (documentFilter.value) {
      params.append('document_id', documentFilter.value);
    }
    
    if (paragraphTypeFilter.value) {
      params.append('type', paragraphTypeFilter.value);
    }
    
    if (tagFilter.value) {
      params.append('tag_id', tagFilter.value);
    }
    
    if (duplicateFilter.value) {
      params.append('show_all_duplicates', duplicateFilter.value);
    }
    
    if (parseInt(minLengthFilter.value) > 0) {
      params.append('min_length', minLengthFilter.value);
    }
    
    if (searchInput.value.trim()) {
      params.append('search', searchInput.value.trim());
    }
    
    // Add sorting
    if (sortOption.value) {
      const [sortField, sortDir] = sortOption.value.split('-');
      params.append('sort_by', sortField);
      params.append('sort_direction', sortDir);
    }
    
    // Fetch paragraphs from API
    fetch(`/api/paragraphs?${params.toString()}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Store data
        allParagraphs = data.paragraphs;
        totalPages = data.total_pages;
        totalItems = data.total_items;
        currentPage = data.current_page;
        
        // Update UI
        updatePaginationInfo();
        renderParagraphs();
        
        // Hide loading
        hideLoading();
        isLoading = false;
        paragraphPlaceholders.style.display = 'none';
      })
      .catch(error => {
        console.error('Error fetching paragraphs:', error);
        hideLoading();
        isLoading = false;
        paragraphPlaceholders.style.display = 'none';
        
        // Show error state
        paragraphsListEl.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <h5 class="mt-3">Error Loading Paragraphs</h5>
            <p class="text-muted">${error.message}</p>
            <button class="btn btn-primary mt-2" onclick="loadParagraphs()">
              <i class="bi bi-arrow-repeat me-1"></i> Try Again
            </button>
          </div>
        `;
      });
  }
  
  // Function to render paragraphs
  function renderParagraphs() {
    // Clear existing content (except placeholders)
    const existingContent = paragraphsListEl.querySelectorAll(':not(#paragraphPlaceholders)');
    existingContent.forEach(element => element.remove());
    
    // If no paragraphs, show empty state
    if (allParagraphs.length === 0) {
      paragraphsListEl.innerHTML += `
        <div class="empty-state">
          <i class="bi bi-file-earmark-x text-muted mb-2" style="font-size: 3rem;"></i>
          <h5>No paragraphs found</h5>
          <p class="text-muted">No paragraphs match your current filter criteria</p>
          <button class="btn btn-primary mt-2" id="resetFiltersButton">
            <i class="bi bi-arrow-repeat me-1"></i> Reset Filters
          </button>
        </div>
      `;
      
      // Add event listener to reset button
      document.getElementById('resetFiltersButton').addEventListener('click', resetFilters);
      return;
    }
    
    // Create HTML for paragraphs
    const paragraphsHTML = allParagraphs.map(para => {
      // Type badge
      let typeBadge = '';
      switch(para.type) {
        case 'header':
          typeBadge = '<span class="badge bg-primary">header</span>';
          break;
        case 'normal':
          typeBadge = '<span class="badge bg-secondary">normal</span>';
          break;
        case 'list_item':
          typeBadge = '<span class="badge bg-success">list item</span>';
          break;
        case 'list':
          typeBadge = '<span class="badge bg-success">list</span>';
          break;
        case 'table':
          typeBadge = '<span class="badge bg-danger">table</span>';
          break;
        case 'boilerplate':
          typeBadge = '<span class="badge bg-warning">boilerplate</span>';
          break;
        default:
          typeBadge = `<span class="badge bg-secondary">${para.type}</span>`;
      }
      
      // Duplicate badge
      const duplicateBadge = para.appearsInMultiple ? 
        '<span class="badge bg-warning"><i class="bi bi-files me-1"></i>Duplicate</span>' : '';
      
      // Occurrence badge
      const occurrenceBadge = `
        <span class="badge bg-info occurrence-badge" onclick="toggleDocumentReferences(this, ${para.id})" title="Click to view document references">
          <i class="bi bi-files me-1"></i>${para.occurrences}
        </span>
      `;
      
      // Tags
      const tagsHTML = para.tags.map(tag => `
        <span class="badge tag-badge" style="background-color: ${tag.color}">
          ${tag.name}
          <i class="bi bi-x ms-1 remove-tag-btn" onclick="removeTag(${para.id}, ${tag.id})"></i>
        </span>
      `).join('');
      
      // Document references
      const docRefsHTML = para.documentReferences.map(doc => `
        <a href="/document/${doc.id}" class="text-decoration-none">
          <span class="badge bg-light text-dark border">
            <i class="bi bi-file-earmark-text me-1"></i>${doc.filename}
          </span>
        </a>
      `).join('');
      
      // Different rendering for list items
      let contentHTML = '';
      if (para.type === 'list_item') {
        contentHTML = `
          <div class="paragraph-preview mb-2">
            ${truncateText(para.content, 150)}
            <button class="btn btn-sm btn-link p-0 ms-1 read-more-btn">Read more</button>
          </div>
          <div class="paragraph-full-content list-item-content p-2 bg-light rounded mb-2" style="display: none;">
            ${para.content.replace(/\n/g, '<br>')}
          </div>
        `;
      } else if (para.type === 'table') {
        contentHTML = `
          <div class="paragraph-preview mb-2">
            ${truncateText(para.content, 150)}
            <button class="btn btn-sm btn-link p-0 ms-1 read-more-btn">Read more</button>
          </div>
          <div class="paragraph-full-content p-2 bg-light rounded mb-2" style="display: none;">
            <pre class="table-content">${para.content}</pre>
          </div>
        `;
      } else {
        contentHTML = `
          <div class="paragraph-preview mb-2">
            ${truncateText(para.content, 150)}
            <button class="btn btn-sm btn-link p-0 ms-1 read-more-btn">Read more</button>
          </div>
          <div class="paragraph-full-content p-2 bg-light rounded mb-2" style="display: none;">
            ${para.content}
          </div>
        `;
      }
      
      // Stats section
      const statsHTML = `
        <div class="content-stats p-2 bg-light rounded mb-2 d-none">
          <div class="row text-center">
            <div class="col-md-3">
              <small class="text-muted">Characters</small>
              <div>${para.contentLength}</div>
            </div>
            <div class="col-md-3">
              <small class="text-muted">Words</small>
              <div>${para.wordCount}</div>
            </div>
            <div class="col-md-3">
              <small class="text-muted">Sentences</small>
              <div>${para.content.split('.').length - 1}</div>
            </div>
            <div class="col-md-3">
              <small class="text-muted">Position</small>
              <div>#${para.position}</div>
            </div>
          </div>
        </div>
      `;
      
      // Create card
      return `
        <div class="card paragraph-card ${para.type} mb-3" 
             data-type="${para.type}" 
             data-id="${para.id}" 
             data-occurrences="${para.occurrences}" 
             data-document="${para.documentName}"
             data-tags="${para.tags.map(t => t.id).join(',')}"
             data-content-length="${para.contentLength}">
          
          <!-- Paragraph Selection Checkbox -->
          <div class="paragraph-select">
            <div class="form-check">
              <input class="form-check-input paragraph-checkbox" type="checkbox" id="selectPara${para.id}" data-para-id="${para.id}">
              <label class="form-check-label" for="selectPara${para.id}"></label>
            </div>
          </div>
          
          <div class="card-header py-2">
            <!-- All metadata, tags, and actions consolidated in the top row -->
            <div class="d-flex justify-content-between align-items-center">
              <!-- Type badges and occurrence info on the left -->
              <div class="d-flex align-items-center gap-2">
                ${typeBadge}
                ${duplicateBadge}
                ${occurrenceBadge}
              </div>
              
              <!-- Tags and action buttons together on the right -->
              <div class="d-flex align-items-center">
                <!-- Tags moved to the right -->
                <div class="paragraph-tags d-flex flex-wrap gap-1 me-2">
                  ${tagsHTML}
                </div>
                
                <!-- Action buttons -->
                <div class="action-buttons d-flex align-items-center gap-1">
                  <button class="btn btn-sm btn-light py-0 px-2" onclick="showTagModal(${para.id})" title="Add Tag">
                    <i class="bi bi-tag"></i>
                  </button>
                  <button class="btn btn-sm btn-light show-stats-btn py-0 px-2" title="Show Statistics">
                    <i class="bi bi-info-circle"></i>
                  </button>
                  <a href="/paragraphs?document_id=${para.documentId}" class="btn btn-sm btn-light py-0 px-2" title="View in Context">
                    <i class="bi bi-eye"></i>
                  </a>
                  <button class="btn btn-sm btn-light toggle-para-btn ms-1" title="Expand/Collapse">
                    <i class="bi bi-arrows-expand"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card-body py-2">
            <!-- Document References - Shows where this paragraph appears -->
            <div class="document-references mb-2 p-2 rounded bg-light" id="docRefs-${para.id}">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <p class="text-muted mb-0 small">
                  <i class="bi bi-files me-1"></i> 
                  ${para.appearsInMultiple ? 'Appears in multiple documents:' : 'Source document:'}
                </p>
              </div>
              <div class="d-flex flex-wrap gap-2">
                ${docRefsHTML}
              </div>
            </div>
            
            ${para.headerContent ? `
              <div class="mb-2 p-2 rounded bg-light">
                <strong><i class="bi bi-type-h1 me-1"></i>Header:</strong> ${para.headerContent}
              </div>
            ` : ''}
            
            <!-- Content sections -->
            ${contentHTML}
            
            <!-- Stats section -->
            ${statsHTML}
          </div>
        </div>
      `;
    }).join('');
    
    // Add paragraphs to container
    paragraphsListEl.innerHTML += paragraphsHTML;
    
    // Set up event listeners for the new elements
    setupContentToggles();
    setupBatchSelection();
    
    // Update paragraph count
    paragraphCountEl.textContent = `${totalItems} paragraphs`;
  }
  
  // Helper function to truncate text
  function truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }
  
  // Update pagination information
  function updatePaginationInfo() {
    currentPageEls.forEach(el => el.textContent = currentPage);
    totalPagesEls.forEach(el => el.textContent = totalPages);
    
    // Enable/disable pagination buttons
    firstPageBtn.disabled = currentPage === 1;
    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage === totalPages;
    lastPageBtn.disabled = currentPage === totalPages;
  }
  
  // Set up event listeners
  function setupEventListeners() {
    // Filter application
    applyFiltersBtn.addEventListener('click', applyFilters);
    resetFiltersBtn.addEventListener('click', resetFilters);
    
    // Pagination controls
    firstPageBtn.addEventListener('click', () => goToPage(1));
    prevPageBtn.addEventListener('click', () => goToPage(currentPage - 1));
    nextPageBtn.addEventListener('click', () => goToPage(currentPage + 1));
    lastPageBtn.addEventListener('click', () => goToPage(totalPages));
    
    // Page size select
    pageSizeSelect.addEventListener('change', function() {
      pageSize = parseInt(this.value);
      currentPage = 1;
      loadParagraphs();
    });
    
    // Search input - enable Enter key
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
    
    // Clear search button
    document.getElementById('clearSearchBtn').addEventListener('click', function() {
      searchInput.value = '';
      applyFilters();
    });
    
    // Expand/Collapse buttons
    expandAllParasBtn.addEventListener('click', expandAllParagraphs);
    collapseAllParasBtn.addEventListener('click', collapseAllParagraphs);
    
    // Statistics button
    document.getElementById('showStatsBtn').addEventListener('click', showStatisticsModal);
    
    // Batch selection buttons
    document.getElementById('selectAllBtn').addEventListener('click', selectAllVisible);
    document.getElementById('deselectAllBtn').addEventListener('click', deselectAll);
    document.getElementById('cancelSelectionBtn').addEventListener('click', cancelSelection);
  }
  
  // Function to toggle document references
  function toggleDocumentReferences(badge, paragraphId) {
    // Find the document references container
    const docRefsContainer = document.getElementById(`docRefs-${paragraphId}`);
    
    // Toggle display
    if (docRefsContainer.classList.contains('show')) {
      docRefsContainer.classList.remove('show');
      badge.classList.remove('active');
    } else {
      // Hide all other document references first
      document.querySelectorAll('.document-references').forEach(container => {
        container.classList.remove('show');
      });
      
      // Remove active class from all badges
      document.querySelectorAll('.occurrence-badge').forEach(b => {
        b.classList.remove('active');
      });
      
      // Show this one
      docRefsContainer.classList.add('show');
      badge.classList.add('active');
    }
  }
  
  // Function to apply filters
  function applyFilters() {
    currentPage = 1;
    loadParagraphs();
  }
  
  // Function to reset filters
  function resetFilters() {
    documentFilter.value = '';
    paragraphTypeFilter.value = '';
    tagFilter.value = '';
    duplicateFilter.value = '0';
    minLengthFilter.value = '0';
    searchInput.value = '';
    sortOption.value = 'occurrences-desc';
    pageSizeSelect.value = '25';
    pageSize = 25;
    
    // Reset and load
    currentPage = 1;
    loadParagraphs();
  }
  
  // Function to navigate to a specific page
  function goToPage(page) {
    if (page < 1 || page > totalPages || isLoading) {
      return;
    }
    
    currentPage = page;
    loadParagraphs();
  }
  
  // Function to set up content toggles
  function setupContentToggles() {
    // Toggle paragraph content
    const readMoreBtns = document.querySelectorAll('.read-more-btn');
    readMoreBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const paragraphCard = this.closest('.paragraph-card');
        const preview = paragraphCard.querySelector('.paragraph-preview');
        const fullContent = paragraphCard.querySelector('.paragraph-full-content');
        
        if (fullContent.style.display === 'none') {
          preview.style.display = 'none';
          fullContent.style.display = 'block';
          
          // Update any toggle buttons in this card
          const toggleBtn = paragraphCard.querySelector('.toggle-para-btn');
          if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="bi bi-arrows-collapse"></i>';
            toggleBtn.title = 'Collapse';
          }
        } else {
          preview.style.display = 'block';
          fullContent.style.display = 'none';
          
          // Update any toggle buttons in this card
          const toggleBtn = paragraphCard.querySelector('.toggle-para-btn');
          if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="bi bi-arrows-expand"></i>';
            toggleBtn.title = 'Expand';
          }
        }
      });
    });
    
    // Toggle paragraphs with the toggle buttons
    const toggleParaBtns = document.querySelectorAll('.toggle-para-btn');
    toggleParaBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const paragraphCard = this.closest('.paragraph-card');
        const preview = paragraphCard.querySelector('.paragraph-preview');
        const fullContent = paragraphCard.querySelector('.paragraph-full-content');
        
        if (fullContent.style.display === 'none') {
          preview.style.display = 'none';
          fullContent.style.display = 'block';
          this.innerHTML = '<i class="bi bi-arrows-collapse"></i>';
          this.title = 'Collapse';
        } else {
          preview.style.display = 'block';
          fullContent.style.display = 'none';
          this.innerHTML = '<i class="bi bi-arrows-expand"></i>';
          this.title = 'Expand';
        }
      });
    });
    
    // Show/hide content stats
    document.querySelectorAll('.show-stats-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const card = this.closest('.paragraph-card');
        const statsContainer = card.querySelector('.content-stats');
        statsContainer.classList.toggle('d-none');
        
        // Update button text
        if (statsContainer.classList.contains('d-none')) {
          this.innerHTML = '<i class="bi bi-info-circle"></i>';
          this.title = 'Show Statistics';
        } else {
          this.innerHTML = '<i class="bi bi-x-circle"></i>';
          this.title = 'Hide Statistics';
        }
      });
    });
  }
  
  // Function to expand all paragraphs
  function expandAllParagraphs() {
    if (isLoading) return;
    
    showLoading('Expanding all paragraphs...');
    
    setTimeout(() => {
      document.querySelectorAll('.paragraph-card').forEach(card => {
        const preview = card.querySelector('.paragraph-preview');
        const fullContent = card.querySelector('.paragraph-full-content');
        const toggleBtn = card.querySelector('.toggle-para-btn');
        
        if (preview && fullContent) {
          preview.style.display = 'none';
          fullContent.style.display = 'block';
          if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="bi bi-arrows-collapse"></i>';
            toggleBtn.title = 'Collapse';
          }
        }
      });
      
      hideLoading();
      showToast('All paragraphs expanded');
    }, 10);
  }
  
  // Function to collapse all paragraphs
  function collapseAllParagraphs() {
    if (isLoading) return;
    
    showLoading('Collapsing all paragraphs...');
    
    setTimeout(() => {
      document.querySelectorAll('.paragraph-card').forEach(card => {
        const preview = card.querySelector('.paragraph-preview');
        const fullContent = card.querySelector('.paragraph-full-content');
        const toggleBtn = card.querySelector('.toggle-para-btn');
        
        if (preview && fullContent) {
          preview.style.display = 'block';
          fullContent.style.display = 'none';
          if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="bi bi-arrows-expand"></i>';
            toggleBtn.title = 'Expand';
          }
        }
      });
      
      hideLoading();
      showToast('All paragraphs collapsed');
    }, 10);
  }
  
  // Set up batch selection
  function setupBatchSelection() {
    // Get all checkboxes
    const checkboxes = document.querySelectorAll('.paragraph-checkbox');
    
    // Add change event listener to each checkbox
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateBatchSelectionUI);
    });
  }
  
  // Update batch selection UI
  function updateBatchSelectionUI() {
    const checkboxes = document.querySelectorAll('.paragraph-checkbox');
    const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    
    // Update selected count
    selectedCountEl.textContent = `${selectedCount} selected`;
    
    // Show/hide batch action bar
    if (selectedCount > 0) {
      batchActionBar.classList.add('visible');
    } else {
      batchActionBar.classList.remove('visible');
    }
  }
  
  // Select all visible paragraphs
  function selectAllVisible() {
    document.querySelectorAll('.paragraph-checkbox').forEach(checkbox => {
      checkbox.checked = true;
    });
    
    updateBatchSelectionUI();
    showToast('Selected all paragraphs');
  }
  
  // Deselect all paragraphs
  function deselectAll() {
    document.querySelectorAll('.paragraph-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    
    updateBatchSelectionUI();
    showToast('Deselected all paragraphs');
  }
  
  // Cancel selection
  function cancelSelection() {
    deselectAll();
  }
  
  // Batch tag selected paragraphs
  function batchTagSelected(tagId) {
    // Get all selected paragraph IDs
    const selectedElements = document.querySelectorAll('.paragraph-checkbox:checked');
    const selectedIds = Array.from(selectedElements).map(el => el.dataset.paraId);
    
    if (selectedIds.length === 0) {
      showToast('No paragraphs selected', 'warning');
      return;
    }
    
    showLoading(`Tagging ${selectedIds.length} paragraphs...`);
    
    // Process each paragraph one by one
    let processed = 0;
    let successful = 0;
    
    function processNext() {
      if (processed >= selectedIds.length) {
        // All done
        hideLoading();
        if (successful > 0) {
          showToast(`Successfully tagged ${successful} paragraphs`, 'success');
          // Reload paragraphs to show updated tags
          setTimeout(() => loadParagraphs(), 1000);
        } else {
          showToast('Failed to tag paragraphs', 'danger');
        }
        return;
      }
      
      const paraId = selectedIds[processed];
      
      // Create FormData for the request
      const formData = new FormData();
      formData.append('paragraph_id', paraId);
      formData.append('tag_id', tagId);
      formData.append('tag_all_duplicates', 'true');
      
      fetch('/tag-paragraph', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          successful++;
        }
        
        // Process next paragraph
        processed++;
        processNext();
      })
      .catch(error => {
        console.error('Error tagging paragraph:', error);
        
        // Continue with next paragraph
        processed++;
        processNext();
      });
    }
    
    // Start processing
    processNext();
  }
  
  // Show tag modal
  function showTagModal(paragraphId) {
    document.getElementById('paragraphIdForTag').value = paragraphId;
    new bootstrap.Modal(document.getElementById('tagModal')).show();
  }
  
  // Add tag to paragraph
  function addTag(tagId) {
    const paragraphId = document.getElementById('paragraphIdForTag').value;
    
    // Show loading state
    const tagSelection = document.querySelector('.tag-selection');
    tagSelection.innerHTML = `
      <div class="w-100 text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 mb-0">Adding tag to all instances of this paragraph...</p>
      </div>
    `;
    
    // Create FormData for more reliable parameter passing
    const formData = new FormData();
    formData.append('paragraph_id', paragraphId);
    formData.append('tag_id', tagId);
    formData.append('tag_all_duplicates', 'true');
    
    fetch('/tag-paragraph', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Hide the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('tagModal'));
        modal.hide();
        
        // Show success message
        showToast('Tag added successfully');
        
        // Reload paragraphs to reflect changes
        setTimeout(() => loadParagraphs(), 500);
      } else {
        showToast('Failed to add tag: ' + (data.message || 'Unknown error'), 'danger');
        
        // Hide the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('tagModal'));
        modal.hide();
        
        // Restore tag selection after a short delay
        setTimeout(() => loadParagraphs(), 500);
      }
    })
    .catch(error => {
      console.error('Error adding tag:', error);
      showToast('An error occurred while adding the tag', 'danger');
      
      // Hide the modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('tagModal'));
      modal.hide();
      
      // Restore tag selection after a short delay
      setTimeout(() => loadParagraphs(), 500);
    });
  }
  
  // Remove tag from paragraph
  function removeTag(paragraphId, tagId) {
    if (!confirm('Are you sure you want to remove this tag from all instances of this paragraph?')) {
      return;
    }
    
    showLoading('Removing tag...');
    
    // Create FormData for more reliable parameter passing
    const formData = new FormData();
    formData.append('paragraph_id', paragraphId);
    formData.append('tag_id', tagId);
    formData.append('untag_all_duplicates', 'true');
    
    fetch('/untag-paragraph', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      hideLoading();
      
      if (data.success) {
        showToast('Tag removed successfully');
        
        // Reload paragraphs to reflect changes
        setTimeout(() => loadParagraphs(), 500);
      } else {
        showToast('Failed to remove tag: ' + (data.message || 'Unknown error'), 'danger');
      }
    })
    .catch(error => {
      hideLoading();
      console.error('Error removing tag:', error);
      showToast('An error occurred while removing the tag', 'danger');
    });
  }
  
  // Show toast notification
  function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
      document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    // Toast content
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    // Add to container
    toastContainer.appendChild(toastEl);
    
    // Initialize and show the toast
    const toast = new bootstrap.Toast(toastEl, {
      autohide: true,
      delay: 3000
    });
    toast.show();
    
    // Remove from DOM after it's hidden
    toastEl.addEventListener('hidden.bs.toast', function() {
      toastEl.remove();
    });
  }
  
  // Set up compact view toggle
  function setupCompactViewToggle() {
    viewToggleBtn.addEventListener('click', function() {
      document.body.classList.toggle('compact-mode');
      compactModeEnabled = document.body.classList.contains('compact-mode');
      
      // Update the icon
      if (compactModeEnabled) {
        viewToggleBtn.innerHTML = '<i class="bi bi-layout-text-window"></i>';
        viewToggleBtn.title = 'Switch to Normal View';
        showToast('Compact view enabled');
      } else {
        viewToggleBtn.innerHTML = '<i class="bi bi-layout-text-window-reverse"></i>';
        viewToggleBtn.title = 'Switch to Compact View';
        showToast('Normal view enabled');
      }
    });
  }
  
  // Show/hide loading overlay
  function showLoading(message = 'Processing...') {
    document.getElementById('loadingMessage').textContent = message;
    loadingOverlay.style.display = 'flex';
  }
  
  function hideLoading() {
    loadingOverlay.style.display = 'none';
  }
  
  // Show statistics modal
  function showStatisticsModal() {
    showLoading('Generating statistics...');
    
    // Use setTimeout to avoid blocking the UI
    setTimeout(() => {
      try {
        // In a real implementation, you might want to fetch statistics from the API
        // For now, we'll just generate statistics from the paragraphs we have
        renderStatisticsCharts();
        
        // Show the modal
        new bootstrap.Modal(document.getElementById('statisticsModal')).show();
        
        hideLoading();
      } catch (error) {
        console.error('Error generating statistics:', error);
        hideLoading();
        showToast('Error generating statistics', 'danger');
      }
    }, 100);
  }
  
  // Render statistics charts
  function renderStatisticsCharts() {
    // This is a simplified version - in a real implementation
    // you might want to fetch more comprehensive statistics from the server
    
    // Type distribution
    const typeDistribution = {};
    allParagraphs.forEach(para => {
      if (!typeDistribution[para.type]) {
        typeDistribution[para.type] = 0;
      }
      typeDistribution[para.type]++;
    });
    
    // Render charts
    renderTypeDistributionChart(typeDistribution);
    renderLengthDistributionChart();
    renderTagDistributionChart();
    renderDocumentDistributionChart();
  }
  
  // Chart rendering functions (simplified)
  function renderTypeDistributionChart(typeDistribution) {
    const container = document.getElementById('typeDistributionChart');
    const legend = document.querySelector('.type-legend');
    
    // Clear containers
    container.innerHTML = '';
    legend.innerHTML = '';
    
    // Transform data for chart
    const labels = Object.keys(typeDistribution);
    const data = Object.values(typeDistribution);
    const total = data.reduce((sum, val) => sum + val, 0);
    
    // Color map for paragraph types
    const colorMap = {
      'header': '#007bff',    // primary
      'normal': '#6c757d',    // secondary
      'list': '#28a745',      // success
      'list_item': '#28a745', // same as list
      'table': '#dc3545',     // danger
      'boilerplate': '#ffc107', // warning
      'footer': '#17a2b8',    // info
      'unknown': '#343a40'    // dark
    };
    
    // Create a simple bar chart
    const chartHtml = `
      <div class="d-flex justify-content-between align-items-end" style="height: 100%;">
        ${labels.map((label, i) => {
          const percentage = (data[i] / total * 100).toFixed(1);
          const color = colorMap[label] || '#6c757d';
          return `
            <div class="d-flex flex-column align-items-center">
              <div class="text-center small mb-1">${percentage}%</div>
              <div style="background-color: ${color}; width: ${100 / labels.length * 0.8}%; height: ${percentage * 2}px; 
                         max-height: 190px; min-height: 20px;"></div>
            </div>
          `;
        }).join('')}
      </div>
    `;
    
    container.innerHTML = chartHtml;
    
    // Create legend
    const legendHtml = labels.map(label => {
      const count = typeDistribution[label];
      const color = colorMap[label] || '#6c757d';
      return `
        <div class="d-flex align-items-center mb-1">
          <div style="width: 12px; height: 12px; background-color: ${color}; margin-right: 5px;"></div>
          <span>${label} (${count})</span>
        </div>
      `;
    }).join('');
    
    legend.innerHTML = legendHtml;
  }
  
  // Simplified placeholders for other chart functions
  function renderLengthDistributionChart() {
    document.getElementById('lengthDistributionChart').innerHTML = 
      '<div class="text-center text-muted py-5">Length distribution chart</div>';
  }
  
  function renderTagDistributionChart() {
    document.getElementById('tagUsageChart').innerHTML = 
      '<div class="text-center text-muted py-5">Tag usage chart</div>';
  }
  
  function renderDocumentDistributionChart() {
    document.getElementById('documentDistribution').innerHTML = 
      '<div class="text-center text-muted py-5">Document distribution chart</div>';
  }
</script>
{% endblock scripts %}